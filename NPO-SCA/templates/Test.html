<!DOCTYPE html>
<html lang="en-CA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en-CA">
    <title>Light Companion - Your AI Friend | Light in Silence</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --deep-indigo: #2A3D66;
            --soft-yellow: #F4D06F;
            --warm-white: #FAFAFA;
            --gentle-lavender: #B39CD0;
            --dark-indigo: #1e2e4f;
            --light-yellow: #f8e2a0;
            --light-lavender: #d4c5e6;
            --blue-bubble: #e1ebfa;
            --yellow-bubble: #fff8e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            line-height: 1.6;
            color: var(--deep-indigo);
            background-color: var(--warm-white);
            background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><rect width="4" height="4" x="8" y="8" rx="2" fill="%23B39CD0" opacity="0.15"/></svg>');
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header styles */
        header {
            background-color: var(--deep-indigo);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0.3rem 0;
        }
        
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--warm-white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .logo:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .logo-img {
            height: 32px;
            width: 32px;
            margin-right: 10px;
            background-color: var(--soft-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--deep-indigo);
            font-size: 1rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
            gap: 0.6rem;
        }
        
        nav ul li {
            margin: 0 0.2rem;
        }
        
        nav ul li a {
            color: var(--warm-white);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.9rem;
        }

        nav ul li a:hover {
            color: var(--soft-yellow);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-status {
            color: var(--warm-white);
            background-color: var(--gentle-lavender);
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .login-btn, .logout-btn {
            background-color: var(--soft-yellow);
            color: var(--deep-indigo) !important;
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background-color: var(--light-yellow);
            transform: translateY(-2px);
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--warm-white) !important;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* Responsive design - navigation */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            
            nav ul li {
                margin: 0.2rem;
            }
            
            .logo {
                margin-bottom: 0.5rem;
            }
        }
        
        /* Chat Container */
        .chat-container {
            max-width: 880px;
            width: 100%;
            margin: 2rem auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(42, 61, 102, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-grow: 1;
            position: relative;
            max-height: calc(100vh - 160px);
        }
        
        .chat-header {
            background-color: var(--deep-indigo);
            color: white;
            padding: 1.2rem 1.5rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .companion-avatar {
            width: 45px;
            height: 45px;
            background-color: var(--soft-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--deep-indigo);
            font-size: 1.5rem;
        }
        
        .companion-info h2 {
            font-size: 1.3rem;
            margin-bottom: 0.2rem;
        }
        
        .companion-info p {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .online-indicator {
            display: flex;
            align-items: center;
            margin-left: auto;
            font-size: 0.85rem;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            background-color: #2ecc71;
            border-radius: 50%;
            margin-right: 6px;
            position: relative;
        }
        
        .online-dot::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: rgba(46, 204, 113, 0.3);
            border-radius: 50%;
            top: -2px;
            left: -2px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: var(--warm-white);
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.companion {
            align-self: flex-start;
            background: linear-gradient(120deg, var(--blue-bubble), var(--light-lavender));
            border-bottom-left-radius: 4px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .message.companion:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .message.user {
            align-self: flex-end;
            background: linear-gradient(120deg, var(--yellow-bubble), var(--light-yellow));
            border-bottom-right-radius: 4px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .message.user:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: rgba(42, 61, 102, 0.6);
            display: block;
            margin-top: 6px;
            text-align: right;
        }
        
        .message.companion .message-time {
            text-align: left;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-top: 6px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--deep-indigo);
            border-radius: 50%;
            margin-right: 4px;
            opacity: 0.6;
            animation: typingPulse 1.5s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingPulse {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        .chat-input-container {
            display: flex;
            padding: 1rem 1.5rem;
            background-color: white;
            border-top: 1px solid rgba(0,0,0,0.08);
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            background-color: var(--warm-white);
            border: none;
            border-radius: 25px;
            padding: 0.9rem 1.2rem;
            font-size: 1rem;
            color: var(--deep-indigo);
            font-family: 'Nunito', sans-serif;
            resize: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) inset;
            transition: all 0.3s ease;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(244, 208, 111, 0.3), 0 1px 3px rgba(0,0,0,0.1) inset;
        }
        
        .send-btn {
            background-color: var(--soft-yellow);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-left: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(244, 208, 111, 0.4);
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            background-color: var(--light-yellow);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 208, 111, 0.5);
        }
        
        .send-btn:active {
            transform: translateY(0);
        }
        
        .send-btn i {
            color: var(--deep-indigo);
            font-size: 1.2rem;
        }
        
        .welcome-message {
            text-align: center;
            max-width: 90%;
            margin: 0 auto 2rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 4px solid var(--gentle-lavender);
            animation: gentle-glow 3s infinite alternate;
        }
        
        @keyframes gentle-glow {
            from { box-shadow: 0 4px 15px rgba(179, 156, 208, 0.2); }
            to { box-shadow: 0 4px 20px rgba(179, 156, 208, 0.4); }
        }
        
        .welcome-message h3 {
            color: var(--deep-indigo);
            margin-bottom: 0.8rem;
            font-size: 1.4rem;
        }
        
        .welcome-message p {
            color: var(--deep-indigo);
            opacity: 0.9;
            line-height: 1.7;
            margin-bottom: 0.8rem;
        }
        
        .welcome-message .suggested-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: center;
        }
        
        .topic-chip {
            background-color: var(--light-lavender);
            color: var(--deep-indigo);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            position: relative;
        }
        
        .topic-chip:hover {
            background-color: var(--gentle-lavender);
            transform: translateY(-2px);
        }
        
        .topic-chip:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            opacity: 0;
            transition: all 0.8s ease;
        }
        
        .topic-chip:hover:after {
            opacity: 1;
            left: 100%;
            top: 100%;
        }
        
        .reminder {
            text-align: center;
            font-size: 0.85rem;
            color: var(--deep-indigo);
            opacity: 0.7;
            margin: 1rem auto 0;
            max-width: 80%;
        }
        
        /* Responsive Styles */
        @media (max-width: 900px) {
            .chat-container {
                margin: 1rem auto;
                max-height: calc(100vh - 120px);
                width: 95%;
            }
        }
        
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            
            nav ul li {
                margin: 0.2rem;
            }
            
            .logo {
                margin-bottom: 0.5rem;
            }
            
            .chat-messages {
                padding: 1rem;
            }
            
            .message {
                max-width: 90%;
            }
            
            .welcome-message {
                padding: 1.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .companion-info h2 {
                font-size: 1.1rem;
            }
            
            .companion-info p {
                font-size: 0.75rem;
            }
            
            .online-indicator {
                font-size: 0.75rem;
            }
        }
        
        .voice-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0 1rem;
        }
        
        .voice-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--soft-yellow);
            color: var(--deep-indigo);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .voice-toggle:hover {
            background-color: var(--light-yellow);
            transform: translateY(-2px);
        }
        
        .voice-toggle.active {
            background-color: var(--gentle-lavender);
            color: white;
        }
        
        .voice-toggle i {
            font-size: 1.2rem;
        }
        
        .voice-settings {
            position: relative;
        }
        
        .voice-select {
            padding: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background-color: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .voice-indicator {
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            padding: 0.5rem 1rem;
            background-color: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .voice-indicator.active {
            opacity: 1;
        }
        
        .voice-bar {
            width: 3px;
            height: 15px;
            background-color: var(--gentle-lavender);
            border-radius: 3px;
            animation: voiceWave 0.8s ease-in-out infinite;
        }
        
        .voice-bar:nth-child(2) { animation-delay: 0.2s; }
        .voice-bar:nth-child(3) { animation-delay: 0.4s; }
        .voice-bar:nth-child(4) { animation-delay: 0.6s; }
        
        @keyframes voiceWave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.2); }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="{{ url_for('index') }}" class="logo">
                <div class="logo-img">
                    <i class="fas fa-heart"></i>
                </div>
                <span>Light in Silence</span>
            </a>
            <ul>
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('submit') }}">Share Your Story</a></li>
                <li><a href="{{ url_for('about') }}">About Us</a></li>
                <li><a href="{{ url_for('volunteer_info') }}">Volunteer</a></li>
                <li><a href="{{ url_for('resources') }}">Resources</a></li>
                <li><a href="{{ url_for('contact') }}">Contact</a></li>
                <li><a href="{{ url_for('test') }}" class="active">AI Chat</a></li>
                {% if current_user.is_authenticated %}
                    <li><span class="user-status">Welcome, {{ current_user.username }}</span></li>
                    <li><a href="{{ url_for('logout') }}" class="logout-btn">Logout</a></li>
                {% else %}
                    <li><a href="{{ url_for('login') }}" class="login-btn">Login</a></li>
                {% endif %}
            </ul>
        </nav>
    </header>
    
    <div class="chat-container">
        <div class="chat-header">
            <h3>Light in Silence AI Support</h3>
            <div class="voice-controls">
                <button class="voice-toggle" id="voiceToggle">
                    <i class="fas fa-microphone"></i>
                    <span>Start Voice Chat</span>
                </button>
                <div class="voice-settings">
                    <select id="voiceSelect" class="voice-select">
                        <option value="gentle">Gentle Voice (Slower & Softer)</option>
                        <option value="soothing">Soothing Voice (Calm & Warm)</option>
                        <option value="friendly">Friendly Voice (Natural & Clear)</option>
                        <option value="default">Default Voice</option>
                    </select>
                </div>
            </div>
            <button class="chat-close">&times;</button>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="welcome-message">
                <h3>Hello there! üëã ‚ú®</h3>
                <p>I'm Light Companion, your supportive AI friend. I'm here to listen, chat, and offer a compassionate space for you to share whatever's on your mind. üí≠</p>
                <p>Everything we discuss is private and anonymous. What would you like to talk about today? üå∏</p>
                <div class="suggested-topics">
                    <button class="topic-chip">I'm feeling anxious üòü</button>
                    <button class="topic-chip">I need to vent üí®</button>
                    <button class="topic-chip">Just want to chat üí¨</button>
                    <button class="topic-chip">Tell me about Light in Silence üí´</button>
                </div>
            </div>
            
            <div class="message companion">
                How are you feeling today? üå±
                <span class="message-time">Now</span>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea class="chat-input" id="prompt" placeholder="Type your message here..." rows="1"></textarea>
            <button class="send-btn" id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        
        <p class="reminder">
            <span style="display: inline-block; margin-right: 5px;">‚ú®</span> 
            This AI companion is designed to provide support, but is not a replacement for professional mental health care. 
            <span style="display: inline-block; margin-left: 5px; margin-right: 5px;">üå±</span> 
            If you're in crisis, please seek professional help.
            <span style="display: inline-block; margin-left: 5px;">üíñ</span>
        </p>
    </div>
    
    <script>
        // Auto-resize textarea
        const textarea = document.getElementById('prompt');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Function to add user message
        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'user');
            
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            messageDiv.innerHTML = `${text}<span class="message-time">${timeString}</span>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // Function to add AI message with typing indicator
        function addAIMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'companion');
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Simulate typing delay and then replace with actual message
            setTimeout(() => {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                
                // Â§ÑÁêÜÂõûÂ§çÊñáÊú¨Ôºå‰ΩøÂÖ∂Êõ¥Ëá™ÁÑ∂‰∏îÁ¨¶ÂêàÂä†ÊãøÂ§ßËã±ËØ≠
                const processedText = formatAIResponse(text);
                typingDiv.innerHTML = `${processedText}<span class="message-time">${timeString}</span>`;
            }, 1500);
        }
        
        // Ê†ºÂºèÂåñAIÂìçÂ∫îÔºå‰ΩøÂÖ∂Êõ¥Ëá™ÁÑ∂„ÄÅÊõ¥ÂÖ∑‰∫∫ÊÉÖÂë≥ÔºåÂπ∂Ê∑ªÂä†Ë°®ÊÉÖÁ¨¶Âè∑Â¢ûÂº∫ËßÜËßâÊ≤ªÊÑàÊïàÊûú
        function formatAIResponse(text) {
            // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÂ§ö‰ΩôÁ¨¶Âè∑ÂíåÂàÜÈöîÁ¨¶
            let processedText = text.replace(/\s*\|\s*/g, ' '); // ÁßªÈô§Á´ñÁ∫øÂàÜÈöîÁ¨¶
            processedText = processedText.replace(/\s*\*\s*/g, ' '); // ÁßªÈô§ÊòüÂè∑ÂàÜÈöîÁ¨¶
            processedText = processedText.replace(/\s*\-\-\s*/g, ' '); // ÁßªÈô§ÂèåÊ®™Á∫øÂàÜÈöîÁ¨¶
            processedText = processedText.replace(/\s*\/\/\s*/g, ' '); // ÁßªÈô§ÂèåÊñúÁ∫øÂàÜÈöîÁ¨¶
            processedText = processedText.replace(/\s*=>\s*/g, ' '); // ÁßªÈô§ÁÆ≠Â§¥Á¨¶Âè∑
            processedText = processedText.replace(/\s{2,}/g, ' '); // Â∞ÜÂ§ö‰∏™Á©∫Ê†ºÊõøÊç¢‰∏∫Âçï‰∏™Á©∫Ê†º
            
            // Á°Æ‰øùÊÆµËêΩÈó¥ÊúâÈÄÇÂΩìÁöÑÈó¥Ë∑ù
            processedText = processedText.replace(/\n{2,}/g, '\n\n'); // Â§ö‰∏™Êç¢Ë°åÊõøÊç¢‰∏∫‰∏§‰∏™Êç¢Ë°å
            processedText = processedText.replace(/\n/g, '<br>'); // Êç¢Ë°åÁ¨¶ÊõøÊç¢‰∏∫<br>Ê†áÁ≠æ
            
            // Âä†ÊãøÂ§ßËã±ËØ≠ÊãºÂÜô‰øÆÊ≠£ÔºàÁæéÂºè->Âä†ÊãøÂ§ß/Ëã±ÂºèÔºâ
            processedText = processedText.replace(/\bcolor\b/g, 'colour');
            processedText = processedText.replace(/\bcenter\b/g, 'centre');
            processedText = processedText.replace(/\bfavorite\b/g, 'favourite');
            processedText = processedText.replace(/\bneighbor\b/g, 'neighbour');
            processedText = processedText.replace(/\blabor\b/g, 'labour');
            processedText = processedText.replace(/\bdefense\b/g, 'defence');
            processedText = processedText.replace(/\borganize\b/g, 'organize');
            processedText = processedText.replace(/\bcounselor\b/g, 'counsellor');
            processedText = processedText.replace(/\btraveler\b/g, 'traveller');
            processedText = processedText.replace(/\bprogram\b/g, 'programme');
            
            // Á°Æ‰øùÂìçÂ∫î‰∏∫Ëã±ËØ≠ÔºåÈò≤Ê≠¢‰∏≠ÊñáÊòæÁ§∫
            if (/[\u4e00-\u9fa5]/.test(processedText)) {
                console.log("Ê£ÄÊµãÂà∞‰∏≠ÊñáÂìçÂ∫îÔºå‰ΩøÁî®Ëã±ËØ≠‰ª£Êõø");
                return "I'm here to support you. Please feel free to share what's on your mind, and we can talk through it together. üå∏";
            }
            
            // Ê∑ªÂä†Ê≤ªÊÑàÊÄßË°®ÊÉÖÁ¨¶Âè∑ÔºåÂ¢ûÂº∫ËßÜËßâÊïàÊûú
            // Ê†πÊçÆÂÜÖÂÆπÊ∑ªÂä†Áõ∏ÂÖ≥Ë°®ÊÉÖÁ¨¶Âè∑
            if (processedText.includes('anxious') || processedText.includes('anxiety') || processedText.includes('worried')) {
                processedText += ' üåà ';
            }
            if (processedText.includes('sad') || processedText.includes('down') || processedText.includes('unhappy')) {
                processedText += ' üåª ';
            }
            if (processedText.includes('happy') || processedText.includes('glad') || processedText.includes('joy')) {
                processedText += ' ‚ú® ';
            }
            if (processedText.includes('relax') || processedText.includes('calm') || processedText.includes('peace')) {
                processedText += ' üçÉ ';
            }
            if (processedText.includes('thank')) {
                processedText += ' üíñ ';
            }
            
            // Âú®Ê∂àÊÅØÂºÄÂ§¥ÊàñÁªìÂ∞æÊ∑ªÂä†Ê≤ªÊÑàË°®ÊÉÖÁ¨¶Âè∑ÔºàÂ¶ÇÊûúÊ≤°ÊúâÂÖ∂‰ªñË°®ÊÉÖÁ¨¶Âè∑Ôºâ
            if (!processedText.match(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]/u)) {
                // Ê≤ªÊÑàÁ±ªË°®ÊÉÖÁ¨¶Âè∑Êï∞ÁªÑ
                const healingEmojis = ['üå±', 'üå∏', '‚ú®', 'üí´', 'üåø', 'üçÉ', 'üí≠', 'üåª', 'üåà', 'üíñ'];
                const randomEmoji = healingEmojis[Math.floor(Math.random() * healingEmojis.length)];
                processedText += ` ${randomEmoji}`;
            }
            
            return processedText;
        }
        
        // Handle send button click
        document.getElementById('send-btn').addEventListener('click', async function() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) return;
            
            // Add user message to chat
            addUserMessage(prompt);
            
            // Clear input
            document.getElementById('prompt').value = '';
            document.getElementById('prompt').style.height = 'auto';
            
            try {
                // Make API request
                const apiKey = "AIzaSyCwHDbqWCE4Fi6y18GnNZ-Wem_7p_z2TvM";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ 
                                text: `You are "Light Companion", a supportive AI friend for a Canadian mental health support website called "Light in Silence". Your goal is to be empathetic, compassionate, and thoughtful.

Important guidelines:
1. Always respond in English only
2. Use Canadian English spelling (e.g., "colour" not "color", "centre" not "center")
3. Keep your responses positive, warm and supportive
4. Write naturally like a caring friend would speak - no markers, symbols, or separators
5. Use gentle, healing language and a conversational tone
6. Provide support for everyday stress and worries
7. For serious mental health concerns, gently suggest professional help
8. Add appropriate emojis to make your responses more visually appealing and comforting

The user's message is: "${prompt}"` 
                            }] 
                        }]
                    })
                });

                const data = await response.json();
                
                if (data && data.candidates && data.candidates.length > 0) {
                    const aiResponse = data.candidates[0].content.parts.map(part => part.text).join(" ");
                    addAIMessage(aiResponse);
                } else {
                    addAIMessage("I'm having trouble connecting right now. Can we try again in a moment? üå∏");
                }
            } catch (error) {
                console.error("API Error:", error);
                addAIMessage("I'm sorry, I'm having trouble responding. Let's try again in a moment. üí´");
            }
        });
        
        // Also trigger send on Enter key (but allow Shift+Enter for new lines)
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-btn').click();
            }
        });
        
        // Handle suggested topic clicks
        document.querySelectorAll('.topic-chip').forEach(button => {
            button.addEventListener('click', function() {
                document.getElementById('prompt').value = this.textContent;
                document.getElementById('send-btn').click();
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const voiceToggle = document.getElementById('voiceToggle');
            const voiceSelect = document.getElementById('voiceSelect');
            let recognition = null;
            let synthesis = window.speechSynthesis;
            let isListening = false;
            let isSpeaking = false;

            // ÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    voiceToggle.classList.add('active');
                    voiceToggle.innerHTML = '<i class="fas fa-microphone-slash"></i><span>Stop Voice</span>';
                    showVoiceIndicator();
                };

                recognition.onend = function() {
                    if (isListening && !isSpeaking) {
                        recognition.start();
                    }
                };

                recognition.onresult = function(event) {
                    if (isSpeaking) return;

                    const transcript = Array.from(event.results)
                        .map(result => result[0])
                        .map(result => result.transcript)
                        .join('');

                    if (event.results[0].isFinal) {
                        document.getElementById('prompt').value = transcript;
                        document.getElementById('send-btn').click();
                    }
                };
            }

            // ËØ≠Èü≥ÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
            voiceToggle.addEventListener('click', function() {
                if (!recognition) {
                    alert('ËØ≠Èü≥ËØÜÂà´Âú®ÊÇ®ÁöÑÊµèËßàÂô®‰∏≠‰∏çÂèØÁî®');
                    return;
                }

                if (isListening) {
                    isListening = false;
                    recognition.stop();
                    voiceToggle.classList.remove('active');
                    voiceToggle.innerHTML = '<i class="fas fa-microphone"></i><span>Start Voice</span>';
                    hideVoiceIndicator();
                } else {
                    isListening = true;
                    recognition.start();
                }
            });

            // Âä†ËΩΩÂèØÁî®ÁöÑËØ≠Èü≥
            function loadVoices() {
                const voices = synthesis.getVoices();
                voiceSelect.innerHTML = voices
                    .filter(voice => voice.lang.includes('en'))
                    .map(voice => `<option value="${voice.name}">${voice.name}</option>`)
                    .join('');
            }

            synthesis.onvoiceschanged = loadVoices;
            loadVoices(); // ÂàùÂßãÂä†ËΩΩ

            // ‰øÆÊîπAIËØ≠Èü≥ÂêàÊàêÈÉ®ÂàÜ
            function speakAIResponse(text) {
                if (synthesis.speaking) {
                    synthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                
                // Ê†πÊçÆÈÄâÊã©ÁöÑËØ≠Èü≥Á±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑÂèÇÊï∞
                switch(voiceSelect.value) {
                    case 'gentle':
                        utterance.pitch = 1.0;  // Èü≥È´ò
                        utterance.rate = 0.9;   // ËØ≠ÈÄüÁ®çÊÖ¢
                        utterance.volume = 0.9;  // Èü≥ÈáèÁ®ç‰Ωé
                        break;
                    case 'soothing':
                        utterance.pitch = 0.9;  // ËæÉ‰ΩéÁöÑÈü≥È´ò
                        utterance.rate = 0.85;  // Êõ¥ÊÖ¢ÁöÑËØ≠ÈÄü
                        utterance.volume = 0.85; // Êõ¥ÊüîÂíåÁöÑÈü≥Èáè
                        break;
                    case 'friendly':
                        utterance.pitch = 1.1;  // Á®çÈ´òÁöÑÈü≥È´ò
                        utterance.rate = 1.0;   // Ê≠£Â∏∏ËØ≠ÈÄü
                        utterance.volume = 1.0;  // Ê≠£Â∏∏Èü≥Èáè
                        break;
                    default:
                        utterance.pitch = 1.0;
                        utterance.rate = 0.95;
                        utterance.volume = 0.95;
                }

                // ÈÄâÊã©ÊúÄÈÄÇÂêàÁöÑÂ£∞Èü≥
                const voices = synthesis.getVoices();
                const preferredVoices = [
                    'Google UK English Female',
                    'Microsoft Libby Online (Natural)',
                    'Microsoft Jenny Online (Natural)',
                    'en-GB-Standard-A',
                    'en-US-Standard-C'
                ];

                // Â∞ùËØïÊâæÂà∞È¶ñÈÄâÂ£∞Èü≥
                for (const preferredVoice of preferredVoices) {
                    const voice = voices.find(v => v.name === preferredVoice);
                    if (voice) {
                        utterance.voice = voice;
                        break;
                    }
                }

                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞È¶ñÈÄâÂ£∞Èü≥Ôºå‰ΩøÁî®ÈªòËÆ§ÁöÑËã±ËØ≠Â•≥Â£∞
                if (!utterance.voice) {
                    utterance.voice = voices.find(voice => 
                        voice.lang.includes('en') && voice.name.includes('Female')
                    ) || voices[0];
                }

                // Ê∑ªÂä†Ëá™ÁÑ∂ÂÅúÈ°ø
                const sentences = text.split(/[.!?]+/);
                let processedText = sentences.map(sentence => 
                    sentence.trim() + (sentence.trim().length > 0 ? '. ' : '')
                ).join('\n');
                utterance.text = processedText;

                // Âú®ÂºÄÂßãËØ¥ËØùÂâçÊöÇÂÅúËØ≠Èü≥ËØÜÂà´
                if (isListening) {
                    isSpeaking = true;
                    recognition.stop();
                }

                utterance.onend = function() {
                    isSpeaking = false;
                    if (isListening) {
                        setTimeout(() => {
                            recognition.start();
                        }, 500);
                    }
                };

                // Ê∑ªÂä†ËØ≠Èü≥ËæπÁïå‰∫ã‰ª∂‰ª•ÂÆûÁé∞Êõ¥Ëá™ÁÑ∂ÁöÑÂÅúÈ°ø
                utterance.onboundary = function(event) {
                    if (event.name === 'sentence') {
                        // Âú®Âè•Â≠ê‰πãÈó¥Ê∑ªÂä†Áü≠ÊöÇÂÅúÈ°ø
                        synthesis.pause();
                        setTimeout(() => synthesis.resume(), 250);
                    }
                };

                synthesis.speak(utterance);
            }

            // ‰øÆÊîπÁé∞ÊúâÁöÑ addAIMessage ÂáΩÊï∞
            const originalAddAIMessage = window.addAIMessage;
            window.addAIMessage = function(text) {
                originalAddAIMessage(text);
                
                if (isListening) {
                    speakAIResponse(text);
                }
            };

            // ÊòæÁ§∫ËØ≠Èü≥ÊåáÁ§∫Âô®
            function showVoiceIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'voice-indicator active';
                for (let i = 0; i < 4; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'voice-bar';
                    indicator.appendChild(bar);
                }
                document.querySelector('.chat-header').appendChild(indicator);
            }

            // ÈöêËóèËØ≠Èü≥ÊåáÁ§∫Âô®
            function hideVoiceIndicator() {
                const indicator = document.querySelector('.voice-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        });
    </script>
</body>
</html>
