{% extends "base.html" %}

{% block title %}Share Your Story - E.C.H.O.E{% endblock %}

{% block styles %}
<style>
        /* Main Content */
        main {
            padding: 2rem 1rem 4rem;
            min-height: calc(100vh - 140px); /* Adjusted for base template */
            background: transparent; /* let global background show */
        }
        
        /* Form Container */
        .form-container {
            max-width: 1100px; /* wider so most users avoid scrolling */
            margin: 1rem auto 3rem;
            padding: 2.5rem;
            background: linear-gradient(180deg, rgba(159,197,203,0.18), rgba(248,210,156,0.18));
            border-radius: 20px;
            box-shadow: 0 10px 36px rgba(42, 61, 102, 0.14);
            position: relative;
            overflow: hidden;
        }
        
        .form-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, var(--gentle-lavender), var(--soft-yellow), var(--gentle-lavender));
            border-radius: 10px 10px 0 0;
        }
        
        .form-container h2 {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--deep-indigo);
            font-size: 2rem;
            position: relative;
            padding-bottom: 10px;
        }
        
        .form-container h2::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: var(--soft-yellow);
            border-radius: 2px;
        }
        
        .form-quote {
            text-align: center;
            font-style: italic;
            margin-bottom: 2rem;
            color: var(--deep-indigo);
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .form-intro {
            text-align: center;
        margin-bottom: 2rem;
            color: var(--deep-indigo);
        font-size: 1.1rem;
        line-height: 1.6;
        }
        
        /* Submission Options */
        .submission-options {
            display: flex;
        justify-content: center;
            margin-bottom: 2rem;
        background-color: var(--warm-white);
        border-radius: 10px;
        padding: 5px;
        border: 2px solid var(--gentle-lavender);
        }
        
        .submission-option {
            flex: 1;
            text-align: center;
        padding: 0.8rem 1rem;
            cursor: pointer;
        border-radius: 8px;
            transition: all 0.3s ease;
        font-weight: 600;
            color: var(--deep-indigo);
        }
        
        .submission-option.active {
        background-color: var(--soft-yellow);
        color: var(--deep-indigo);
        transform: scale(1.02);
    }
    
    .submission-option:hover {
        background-color: var(--light-yellow);
        }
        
        /* Form Sections */
    .submission-forms {
        margin-bottom: 2rem;
    }
    
        .form-section {
            display: none;
        animation: fadeIn 0.5s ease-in-out;
        }
        
        .form-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Centered compose area with floating suggestions card */
        .compose-wrap { position: relative; max-width: 860px; margin: 0 auto; }
        /* Invisible wall inside the textarea area */
        .guide-rail {
            position: absolute;
            /* match textarea padding box exactly */
            top: calc(0px + 2px); /* inside border */
            bottom: calc(0px + 2px); /* inside border */
            right: 0;
            width: 36%; /* reserved area for inline suggestions */
            pointer-events: none;
        }
        .rail-divider {
            /* hide visual divider to avoid edge overflow while keeping layout */
            display: none;
        }
        .suggestion-inline {
            position: absolute;
            right: 12px;
            top: 16px;
            width: calc(100% - 24px);
            font-family: 'Sriracha', 'Brush Script MT', cursive; /* alternate font for suggestions */
            color: rgba(159,197,203,0.95); /* brand blue tint */
            pointer-events: none; /* text only, not interactive */
            animation: fadeInUp .35s ease;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .suggestion-inline ul { list-style: none; margin: 0; padding-left: 12px; text-align: left; }
        .suggestion-inline li { margin: 8px 0; opacity: .95; text-align: left; text-indent: 0; white-space: normal; hyphens: auto; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
        .write-zone { position: relative; }
        .write-zone textarea {
            padding-right: 38% !important;
            box-sizing: border-box;
            white-space: pre-wrap; /* keep line breaks, wrap long tokens */
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .suggestion-card {
            background: rgba(255,255,255,0.96);
            border: 1px solid rgba(159,197,203,0.35);
            border-radius: 14px;
            padding: 16px 16px 12px 16px;
            box-shadow: 0 8px 24px rgba(42,61,102,0.12);
            position: absolute;
            width: 300px;
            top: 0;
            right: -340px; /* default on the right side */
        }
        .suggestion-card.left { right: auto; left: -340px; }
        .suggestion-header { display:flex; align-items:center; justify-content: space-between; margin-bottom:8px; }
        .suggestion-toggle { background:none; border:1px solid rgba(159,197,203,0.6); border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:600; }

        /* Add a subtle inner frame to balance background */
        .framed-inner {
            border: 1px solid rgba(159,197,203,0.35);
            border-radius: 16px;
            padding: 18px;
            background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.92));
        }

    /* Form Groups */
        .form-group {
        margin-bottom: 1.5rem;
        }
        
    .form-group label {
            display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
            color: var(--deep-indigo);
        font-size: 1rem;
        }
        
    .form-group input,
    .form-group select,
    .form-group textarea {
            width: 100%;
        padding: 0.8rem 1rem;
        border: 2px solid var(--gentle-lavender);
        border-radius: 10px;
            font-family: inherit;
        font-size: 1rem;
        transition: all 0.3s ease;
            background-color: var(--warm-white);
        }
        
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
            outline: none;
            border-color: var(--soft-yellow);
            box-shadow: 0 0 0 3px rgba(244, 208, 111, 0.2);
        transform: translateY(-2px);
        }
        
        .form-group textarea {
        min-height: 420px;
            resize: vertical;
        font-family: 'Sriracha', 'Georgia', 'Times New Roman', serif; /* warmer, inviting */
        font-size: 1.15rem;
        line-height: 1.8;
        background: linear-gradient(180deg, rgba(159,197,203,0.12), rgba(255,255,255,0.92));
        box-shadow: inset 0 2px 8px rgba(42,61,102,0.06);
        }
        
    /* Submit Button */
        .submit-btn {
            width: 100%;
            background-color: var(--soft-yellow);
            color: var(--deep-indigo);
            border: none;
        padding: 1rem 2rem;
        border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(244, 208, 111, 0.4);
        }
        
        .submit-btn:hover {
            background-color: var(--light-yellow);
        transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(244, 208, 111, 0.5);
        }
        
    /* Location Items */
    .mailbox-locations {
        margin-top: 2rem;
    }
    
    .location-item {
        background-color: var(--warm-white);
        border-left: 4px solid var(--gentle-lavender);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(42, 61, 102, 0.05);
        transition: transform 0.3s ease;
    }
    
    .location-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(42, 61, 102, 0.1);
    }
    
    .location-item h4 {
        color: var(--deep-indigo);
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }
    
    .location-item p {
        margin-bottom: 0.3rem;
        color: var(--deep-indigo);
        opacity: 0.8;
    }
    
    .note {
        text-align: center;
        margin-top: 2rem;
        padding: 1rem;
        background-color: rgba(179, 156, 208, 0.1);
        border-radius: 10px;
        font-style: italic;
    }
    
    .note a {
        color: var(--deep-indigo);
        font-weight: 600;
        text-decoration: none;
        border-bottom: 1px dotted var(--deep-indigo);
    }
    
    .note a:hover {
        color: var(--gentle-lavender);
        }
        
        /* AI Assistance Section */
        .ai-assistance {
            background-color: rgba(179, 156, 208, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 2rem;
        border: 2px solid rgba(179, 156, 208, 0.3);
        }
        
    .ai-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
        }
        
        .ai-link {
            color: var(--deep-indigo);
        cursor: pointer;
        font-weight: 600;
            text-decoration: underline;
        transition: color 0.3s ease;
        }
        
        .ai-link:hover {
            color: var(--gentle-lavender);
        }
        
        /* Privacy Note */
        .privacy-note {
            text-align: center;
            font-size: 0.9rem;
            color: var(--deep-indigo);
        opacity: 0.8;
        font-style: italic;
        padding: 1rem;
        background-color: rgba(244, 208, 111, 0.1);
        border-radius: 10px;
        }
        
        .privacy-note a {
            color: var(--deep-indigo);
        font-weight: 600;
        text-decoration: none;
        border-bottom: 1px dotted var(--deep-indigo);
        }
        
        .privacy-note a:hover {
            color: var(--gentle-lavender);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .form-container {
                padding: 1.8rem 1.2rem;
                margin: 1rem;
            }
            .online-grid { display: block; }
            .side-panel { position: static; margin-top: 16px; }
            
        .submission-options {
                flex-direction: column;
            }
            
        .submission-option {
            margin-bottom: 0.5rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
        <div class="form-container">
            <h2>Share Your Story with E.C.H.O.E</h2>
            <p class="form-quote">Every voice deserves to be echoed.</p>
            <p class="form-intro">A gentle, judgment-free space to share what's on your mind. Our team will read with care and respond within 48 hours.</p>
            
            <div class="submission-options">
                <div class="submission-option active" id="online-option">Online Submission</div>
                <div class="submission-option" id="offline-option">Find Physical Mailboxes</div>
            </div>
            
            <div class="submission-forms">
                <div class="form-section active" id="online-form">
            <div class="framed-inner">
            <div class="compose-wrap" id="composeWrap">
            <form method="POST" action="{{ url_for('submit') }}">
                {{ form.hidden_tag() }}
                
                        <!-- Topic selection hidden to reduce friction; AI will summarize title -->
                        <div class="form-group" style="display:none;">
                    {{ form.topic(class="form-control") }}
                        </div>
                        
                        <div class="form-group write-zone">
                    {{ form.content.label(class="form-label") }}
                    {{ form.content(class="form-control", placeholder="Share your thoughts, feelings, or concerns here...") }}
                    <!-- Inline suggestions rail placed inside the letter section -->
                    <div class="guide-rail" aria-hidden="true" id="guideRail">
                        <div class="rail-divider"></div>
                        <div class="suggestion-inline" id="inlineSuggest" style="top: 64px;">
                            <ul id="inlineTips">
                                <li>It's okay to be brief â€” start with one thought.</li>
                                <li>Share feelings, not just events.</li>
                                <li>Choose Inbox or Anonymous Email for replies.</li>
                            </ul>
                            <div id="inlineQuestion" style="margin-top:6px; opacity:.9;">
                                What feels most important to share right now?
                            </div>
                        </div>
                    </div>
                        </div>
                        
                        <div class="form-group">
                    {{ form.reply_method.label(class="form-label") }}
                    {{ form.reply_method(class="form-control", id="reply-method") }}
                        </div>
                        
                        <div class="form-group" id="email-container" style="display: none;">
                    {{ form.anonymous_email.label(class="form-label") }}
                    {{ form.anonymous_email(class="form-control", placeholder="Your email address (we don't collect any personal information)") }}
                        </div>
                        
                {{ form.submit(class="submit-btn") }}
                    </form>
            </div>
                </div>
                
                <div class="form-section" id="offline-locations">
                    <h3>Find Our Physical Mailboxes</h3>
                    <p>You can write a letter by hand and drop it in one of our tree hole mailboxes located across Canada:</p>
                    
                    <div class="mailbox-locations">
                {% for mailbox in mailboxes %}
                        <div class="location-item">
                    <h4>{{ mailbox.name }}</h4>
                    <p>{{ mailbox.address }}, {{ mailbox.city }}, {{ mailbox.province }}</p>
                    {% if mailbox.description %}
                    <p>{{ mailbox.description }}</p>
                    {% endif %}
                    {% if mailbox.operating_hours %}
                    <p><strong>Hours:</strong> {{ mailbox.operating_hours }}</p>
                    {% endif %}
                </div>
                {% endfor %}
                        
                <p class="note">More locations coming soon! If you'd like to host a mailbox at your community centre, <a href="{{ url_for('contact') }}">please contact us</a>.</p>
                    </div>
                </div>
            </div>
            
            <!-- AI companion prompt removed to simplify the page per new guidance -->
    
    <p class="privacy-note">We respect your privacy. We never track your name, location, or IP address. Read our <a href="{{ url_for('privacy') }}">Privacy Policy</a> to learn more.</p>
            </div>
{% endblock %}

{% block scripts %}
    <script>
        // Show/hide email input based on reply method
        document.getElementById('reply-method').addEventListener('change', function() {
            const emailContainer = document.getElementById('email-container');
            if (this.value === 'anonymous-email') {
                emailContainer.style.display = 'block';
            } else {
                emailContainer.style.display = 'none';
            }
        });
        
        // Toggle between online and offline options
        document.getElementById('online-option').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('offline-option').classList.remove('active');
            
            document.getElementById('online-form').classList.add('active');
            document.getElementById('offline-locations').classList.remove('active');
        });
        
        document.getElementById('offline-option').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('online-option').classList.remove('active');
            
            document.getElementById('offline-locations').classList.add('active');
            document.getElementById('online-form').classList.remove('active');
        });
        
        // Live coaching: analyze textarea as the user types (debounced)
        const draftEl = document.querySelector('#online-form textarea');
        const tipsEl = document.getElementById('inlineTips');
        const questionEl = document.getElementById('inlineQuestion');
        let coachTimer;
        function debounceCoach(){
            clearTimeout(coachTimer);
            coachTimer = setTimeout(async () => {
                try{
                    const content = draftEl.value || '';
                    const r = await fetch('/api/coach', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ content })
                    });
                    const data = await r.json();
                    const tips = Array.isArray(data.tips) ? data.tips : [];
                    tipsEl.innerHTML = '<ul style="margin:0 0 10px 18px; line-height:1.7;">' +
                        tips.map(t => '<li>'+ (t||'').replace(/</g,'&lt;') +'</li>').join('') +
                        '</ul>';
                    if(data.question){ questionEl.textContent = data.question; }
                }catch(e){ /* ignore transient errors */ }
            }, 500);
        }
        if(draftEl){
            draftEl.addEventListener('input', debounceCoach);
            // prime once at load
            debounceCoach();
        }

        // No card toggle; inline rail stays inside the frame
    </script>
{% endblock %} 