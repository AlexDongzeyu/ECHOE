{% extends "base.html" %}

{% block title %}Respond to Letter - {{ super() }}{% endblock %}

{% block styles %}
<style>
  .form-container{max-width:1100px;margin:1rem auto 3rem;padding:2.5rem;background:linear-gradient(180deg,rgba(159,197,203,.18),rgba(248,210,156,.18));border-radius:20px;box-shadow:0 10px 36px rgba(42,61,102,.14);position:relative}
  .framed-inner{border:1px solid rgba(159,197,203,.35);border-radius:16px;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.92))}
  .compose-wrap{position:relative;max-width:860px;margin:0 auto}
  .guide-rail{position:absolute;top:2px;bottom:2px;right:0;width:36%;pointer-events:auto;z-index:2}
  .suggestion-inline{position:absolute;right:12px;top:46%;transform:translateY(-50%);width:calc(100% - 24px);min-height:200px;font-family:'Sriracha','Brush Script MT',cursive;color:rgba(42,61,102,.9);pointer-events:auto;overflow-wrap:anywhere;word-break:break-word;background:rgba(255,255,255,0.96);border:2px solid var(--gentle-lavender);border-radius:16px;padding:14px;box-shadow:0 4px 10px rgba(244,208,111,.35);overflow-y:visible;z-index:3}
  .suggestion-inline ul{list-style:none;margin:0 0 8px 0; padding:0; line-height:1.55}
  .suggestion-inline li{display:flex;align-items:flex-start;gap:10px;margin:6px 0;color:var(--deep-indigo)}
  .suggestion-inline input[type="checkbox"]{margin-top:3px;accent-color: var(--gentle-lavender)}
  .suggestion-title{font-weight:800;color:var(--deep-indigo);margin:0 0 6px 0}
  .write-zone textarea{padding-right:38%!important;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word}
  .letter-box{background:var(--warm-white);border-radius:12px;padding:16px;border:1px solid rgba(159,197,203,.35);white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;max-width:100%}
  .suggestion-toggle-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);z-index:2;width:calc(100% - 24px);height:84px;background:var(--soft-yellow);border:2px solid var(--gentle-lavender);color:var(--deep-indigo);font-weight:800;border-radius:16px;padding:8px 14px;cursor:pointer;box-shadow:0 4px 10px rgba(244,208,111,.35);display:flex;align-items:center;justify-content:center;text-align:center}
  .suggestion-toggle-btn:hover{transform:translateY(-50%) translateY(-2px)}
  .suggestion-toggle-btn.hidden{display:none}
  .suggestion-close{position:absolute;right:6px;top:6px;pointer-events:auto;cursor:pointer;background:transparent;border:none;color:rgba(42,61,102,.6);font-weight:800}
  .suggestion-inline.hidden{display:none}
  /* Match writing page inputs */
  .form-group{margin-bottom:1.5rem}
  .form-label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--deep-indigo)}
  .form-control{width:100%;padding:.8rem 1rem;border:2px solid var(--gentle-lavender);border-radius:10px;background:var(--warm-white);transition:all .3s ease}
  .form-control:focus{outline:none;border-color:var(--soft-yellow);box-shadow:0 0 0 3px rgba(244,208,111,.2);transform:translateY(-2px)}
  textarea.form-control{min-height:420px;resize:vertical;font-family:'Sriracha','Georgia','Times New Roman',serif;font-size:1.15rem;line-height:1.8;background:linear-gradient(180deg, rgba(159,197,203,.12), rgba(255,255,255,.92));box-shadow:inset 0 2px 8px rgba(42,61,102,.06)}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Respond to Letter</h1>
  {% if letter and (letter.anonymous_email or (letter.reply_method and letter.reply_method.startswith('anonymous'))) %}
  <div class="framed-inner" style="margin-bottom:16px;background:linear-gradient(180deg, rgba(248,210,156,.15), rgba(255,255,255,.95));">
    <div style="display:flex;align-items:center;gap:10px;">
      <i class="fas fa-envelope" style="color:var(--deep-indigo);"></i>
      <div>
        <strong>Sender requested an email reply</strong>
        {% if letter.anonymous_email %}<div style="opacity:.85">Email: <span style="font-weight:800">{{ letter.anonymous_email }}</span></div>{% endif %}
        <div class="meta" style="margin-top:4px">Please send your response manually to the email above after posting a short acknowledgement here.</div>
      </div>
    </div>
  </div>
  {% endif %}
  <div class="framed-inner" style="margin-bottom:16px">
    <h3 style="margin-bottom:8px">Original Letter</h3>
    <div class="letter-box">{{ letter.content }}</div>
  </div>
  
  {% if existing_responses %}
  <div class="framed-inner" style="margin-bottom:16px;background:linear-gradient(180deg, rgba(173,203,164,.12), rgba(255,255,255,.95));">
    <h3 style="margin-bottom:12px;color:var(--deep-indigo);display:flex;align-items:center;gap:8px">
      <i class="fas fa-history"></i> Previous Conversation
    </h3>
    {% for resp in existing_responses %}
      <div style="background:#fff;border-left:4px solid var(--gentle-lavender);padding:14px;border-radius:10px;margin-bottom:12px">
        <div style="font-size:0.9rem;opacity:0.7;margin-bottom:8px">
          <i class="fas fa-user-heart"></i> Volunteer replied: {{ resp.created_at.strftime('%b %d, %Y %H:%M') }}
        </div>
        <div style="white-space:pre-wrap;line-height:1.6">{{ resp.content }}</div>
        
        <!-- Show user replies to this response -->
        {% if resp.user_replies.count() > 0 %}
          {% for user_reply in resp.user_replies.order_by(user_reply.__class__.created_at).all() %}
            <div style="background:rgba(248,210,156,0.15);border-left:3px solid var(--soft-yellow);padding:12px;border-radius:8px;margin:10px 0 0 16px">
              <div style="font-size:0.85rem;color:var(--deep-indigo);opacity:0.8;margin-bottom:6px;font-weight:600">
                <i class="fas fa-reply"></i> User replied: {{ user_reply.created_at.strftime('%b %d, %Y %H:%M') }}
                {% if not user_reply.is_read %}
                  <span style="background:var(--soft-yellow);color:var(--deep-indigo);padding:2px 8px;border-radius:10px;font-size:0.75rem;margin-left:6px">New</span>
                {% endif %}
              </div>
              <div style="white-space:pre-wrap;line-height:1.6;font-size:0.95rem">{{ user_reply.content }}</div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="framed-inner">
    <div class="compose-wrap">
      <form method="POST" action="{{ url_for('respond_to_letter', letter_id=letter.unique_id) }}">
        {{ form.hidden_tag() }}
        <div class="form-group write-zone">
          {{ form.content.label(class="form-label") }}
          {{ form.content(rows=14, class="form-control", style="min-height:420px;", placeholder="Write a caring, respectful reply...") }}
          <div class="guide-rail" aria-hidden="true" id="guideRail">
            <button type="button" id="suggestionToggle" class="suggestion-toggle-btn hidden">ðŸ’¬ Show reply checklist</button>
            <div class="rail-divider"></div>
            <div class="suggestion-inline" id="inlineSuggest">
              <button type="button" id="suggestionClose" class="suggestion-close" aria-label="Hide">âœ•</button>
              <p class="suggestion-title">Reply checklist</p>
              <ul id="inlineTips" class="checklist">
                <li><input id="c1" type="checkbox"><label for="c1">Acknowledge one feeling you notice.</label></li>
                <li><input id="c2" type="checkbox"><label for="c2">Reflect a specific detail to show careful reading.</label></li>
                <li><input id="c3" type="checkbox"><label for="c3">Use a warm, nonâ€‘judgmental tone (avoid advice first).</label></li>
                <li><input id="c4" type="checkbox"><label for="c4">Offer one gentle, practical next step (optional).</label></li>
                <li><input id="c5" type="checkbox"><label for="c5">Close with encouragement and care.</label></li>
                <li><input id="c6" type="checkbox"><label for="c6">Avoid diagnosing or making promises you canâ€™t keep.</label></li>
                <li><input id="c7" type="checkbox"><label for="c7">Respect privacy; share resources only if invited.</label></li>
              </ul>
              <div id="inlineQuestion" style="margin-top: 8px; font-style: italic; opacity: 0.8;"></div>
            </div>
          </div>
        </div>
        {{ form.submit(class='btn-primary') }}
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple close interaction for checklist (no AI)
document.addEventListener('DOMContentLoaded', () => {
  const draftEl = document.querySelector('textarea[name="content"]');
  const tipsEl = document.getElementById('inlineTips');
  const questionEl = document.getElementById('inlineQuestion');
  const suggestBox = document.getElementById('inlineSuggest');
  const suggestClose = document.getElementById('suggestionClose');
  const suggestToggle = document.getElementById('suggestionToggle');

  if (!draftEl || !tipsEl || !questionEl || !suggestBox || !suggestClose) {
    console.error('Reply page: missing elements for suggestions');
    return;
  }

  if (suggestClose) {
    suggestClose.addEventListener('click', () => {
      suggestBox.classList.add('hidden');
      if (suggestToggle) suggestToggle.classList.remove('hidden');
    });
  }

  if (suggestToggle) {
    suggestToggle.addEventListener('click', () => {
      suggestBox.classList.remove('hidden');
      suggestToggle.classList.add('hidden');
    });
  }

  // Show by default
  suggestBox.classList.remove('hidden');
  if (suggestToggle) suggestToggle.classList.add('hidden');
});
</script>
{% endblock %}