{% extends "base.html" %}

{% block title %}Respond to Letter - {{ super() }}{% endblock %}

{% block styles %}
<style>
  .form-container{max-width:1100px;margin:1rem auto 3rem;padding:2.5rem;background:linear-gradient(180deg,rgba(159,197,203,.18),rgba(248,210,156,.18));border-radius:20px;box-shadow:0 10px 36px rgba(42,61,102,.14);position:relative}
  .framed-inner{border:1px solid rgba(159,197,203,.35);border-radius:16px;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.92))}
  .compose-wrap{position:relative;max-width:860px;margin:0 auto}
  .guide-rail{position:absolute;top:2px;bottom:2px;right:0;width:36%;pointer-events:none}
  .suggestion-inline{position:absolute;right:12px;top:96px;width:calc(100% - 24px);font-family:'Sriracha','Brush Script MT',cursive;color:rgba(159,197,203,.95);pointer-events:none;overflow-wrap:anywhere;word-break:break-word}
  .suggestion-inline ul{list-style:disc outside;margin:0 0 10px 18px}
  .write-zone textarea{padding-right:38%!important;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word}
  .letter-box{background:var(--warm-white);border-radius:12px;padding:16px;border:1px solid rgba(159,197,203,.35);white-space:pre-wrap}
  /* Match writing page inputs */
  .form-group{margin-bottom:1.5rem}
  .form-label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--deep-indigo)}
  .form-control{width:100%;padding:.8rem 1rem;border:2px solid var(--gentle-lavender);border-radius:10px;background:var(--warm-white);transition:all .3s ease}
  .form-control:focus{outline:none;border-color:var(--soft-yellow);box-shadow:0 0 0 3px rgba(244,208,111,.2);transform:translateY(-2px)}
  textarea.form-control{min-height:420px;resize:vertical;font-family:'Sriracha','Georgia','Times New Roman',serif;font-size:1.15rem;line-height:1.8;background:linear-gradient(180deg, rgba(159,197,203,.12), rgba(255,255,255,.92));box-shadow:inset 0 2px 8px rgba(42,61,102,.06)}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Respond to Letter</h1>
  <div class="framed-inner" style="margin-bottom:16px">
    <h3 style="margin-bottom:8px">Original Letter</h3>
    <div class="letter-box">{{ letter.content }}</div>
  </div>

  <div class="framed-inner">
    <div class="compose-wrap">
      <form method="POST" action="{{ url_for('respond_to_letter', letter_id=letter.unique_id) }}">
        {{ form.hidden_tag() }}
        <div class="form-group write-zone">
          {{ form.content.label(class="form-label") }}
          {{ form.content(rows=14, class="form-control", style="min-height:420px;", placeholder="Write a caring, respectful reply...") }}
          <div class="guide-rail" aria-hidden="true">
            <div class="suggestion-inline" id="replyTips">
              <ul>
                {% if letter.is_flagged %}
                  <li>Gently explain community guidelines and why the wording was flagged.</li>
                  <li>Invite the writer to rephrase while preserving their feelings.</li>
                  <li>Offer help resources when appropriate.</li>
                {% else %}
                  <li>Acknowledge the feeling you notice first.</li>
                  <li>Reflect one detail to show careful reading.</li>
                  <li>Offer one gentle next step or resource.</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        {{ form.submit(class='btn-primary') }}
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Live AI suggestions for replies
document.addEventListener('DOMContentLoaded', () => {
  console.log('Reply page: DOM loaded, initializing coach...');
  const area = document.querySelector('textarea[name="content"]');
  const tipsBox = document.getElementById('replyTips');

  if (!area) {
    console.error('Reply page: textarea not found!');
    return;
  }
  if (!tipsBox) {
    console.error('Reply page: tipsBox not found!');
    return;
  }

  console.log('Reply page: Elements found, setting up coach...');

  let t; let ctrl;
  function debounce(){
    clearTimeout(t);
    t = setTimeout(async () => {
      try{
        const payload = { content: area.value || '', mode: {{ '"rephrase"' if letter.is_flagged else '"reply"' }} };
        console.log('Reply page: Calling coach API with content:', payload.content.substring(0, 50) + '...');
        if (ctrl) { try{ ctrl.abort(); }catch(_){} }
        ctrl = new AbortController();
        const r = await fetch('/api/coach', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: ctrl.signal});
        const data = await r.json();
        console.log('Reply page: Coach API response:', data);
        const tips = Array.isArray(data.tips)?data.tips:[];
        tipsBox.innerHTML = '<ul style="margin:0 0 10px 18px">' + tips.map(x=>'<li>'+ (x||'').replace(/</g,'&lt;') +'</li>').join('') + '</ul>';
        if (data.question) {
          console.log('Reply page: Question:', data.question);
        }
      }catch(e){
        console.error('Reply page: Coach API error:', e);
      }
    }, 350);
  }

  area.addEventListener('input', debounce);
  console.log('Reply page: Event listener added');
  setTimeout(debounce, 200);
});
</script>
{% endblock %}