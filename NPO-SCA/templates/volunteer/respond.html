{% extends "base.html" %}

{% block title %}Respond to Letter - {{ super() }}{% endblock %}

{% block styles %}
<style>
  .form-container{max-width:1100px;margin:1rem auto 3rem;padding:2.5rem;background:linear-gradient(180deg,rgba(159,197,203,.18),rgba(248,210,156,.18));border-radius:20px;box-shadow:0 10px 36px rgba(42,61,102,.14);position:relative}
  .framed-inner{border:1px solid rgba(159,197,203,.35);border-radius:16px;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.92))}
  .compose-wrap{position:relative;max-width:860px;margin:0 auto}
  .guide-rail{position:absolute;top:2px;bottom:2px;right:0;width:36%;pointer-events:auto;z-index:2}
  .suggestion-inline{position:absolute;right:12px;top:50%;transform:translateY(-50%);width:calc(100% - 24px);min-height:200px;max-height:80%;font-family:'Sriracha','Brush Script MT',cursive;color:rgba(159,197,203,.95);pointer-events:auto;overflow-wrap:anywhere;word-break:break-word;background:rgba(255,255,255,0.96);border:2px solid var(--gentle-lavender);border-radius:16px;padding:16px;box-shadow:0 4px 10px rgba(244,208,111,.35);overflow-y:auto;z-index:3}
  .suggestion-inline ul{list-style:disc outside;margin:0 0 10px 18px}
  .write-zone textarea{padding-right:38%!important;white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word}
  .letter-box{background:var(--warm-white);border-radius:12px;padding:16px;border:1px solid rgba(159,197,203,.35);white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;max-width:100%}
  .suggestion-toggle-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);z-index:2;width:calc(100% - 24px);height:84px;background:var(--soft-yellow);border:2px solid var(--gentle-lavender);color:var(--deep-indigo);font-weight:800;border-radius:16px;padding:8px 14px;cursor:pointer;box-shadow:0 4px 10px rgba(244,208,111,.35);display:flex;align-items:center;justify-content:center;text-align:center}
  .suggestion-toggle-btn:hover{transform:translateY(-50%) translateY(-2px)}
  .suggestion-toggle-btn.hidden{display:none}
  .suggestion-close{position:absolute;right:6px;top:6px;pointer-events:auto;cursor:pointer;background:transparent;border:none;color:rgba(42,61,102,.6);font-weight:800}
  .suggestion-inline.hidden{display:none}
  /* Match writing page inputs */
  .form-group{margin-bottom:1.5rem}
  .form-label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--deep-indigo)}
  .form-control{width:100%;padding:.8rem 1rem;border:2px solid var(--gentle-lavender);border-radius:10px;background:var(--warm-white);transition:all .3s ease}
  .form-control:focus{outline:none;border-color:var(--soft-yellow);box-shadow:0 0 0 3px rgba(244,208,111,.2);transform:translateY(-2px)}
  textarea.form-control{min-height:420px;resize:vertical;font-family:'Sriracha','Georgia','Times New Roman',serif;font-size:1.15rem;line-height:1.8;background:linear-gradient(180deg, rgba(159,197,203,.12), rgba(255,255,255,.92));box-shadow:inset 0 2px 8px rgba(42,61,102,.06)}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Respond to Letter</h1>
  <div class="framed-inner" style="margin-bottom:16px">
    <h3 style="margin-bottom:8px">Original Letter</h3>
    <div class="letter-box">{{ letter.content }}</div>
  </div>

  <div class="framed-inner">
    <div class="compose-wrap">
      <form method="POST" action="{{ url_for('respond_to_letter', letter_id=letter.unique_id) }}">
        {{ form.hidden_tag() }}
        <div class="form-group write-zone">
          {{ form.content.label(class="form-label") }}
          {{ form.content(rows=14, class="form-control", style="min-height:420px;", placeholder="Write a caring, respectful reply...") }}
          <div class="guide-rail" aria-hidden="true" id="guideRail">
            <button type="button" id="suggestionToggle" class="suggestion-toggle-btn">ðŸ’¬ Need ideas? Click for suggestions</button>
            <div class="rail-divider"></div>
            <div class="suggestion-inline hidden" id="inlineSuggest">
              <button type="button" id="suggestionClose" class="suggestion-close" aria-label="Hide">âœ•</button>
              <ul id="inlineTips"></ul>
              <div id="inlineQuestion" style="margin-top: 8px; font-style: italic; opacity: 0.8;"></div>
            </div>
          </div>
        </div>
        {{ form.submit(class='btn-primary') }}
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Mirror submit page suggestion UX for reply (mode=reply / rephrase)
document.addEventListener('DOMContentLoaded', () => {
  const draftEl = document.querySelector('textarea[name="content"]');
  const tipsEl = document.getElementById('inlineTips');
  const questionEl = document.getElementById('inlineQuestion');
  const suggestBox = document.getElementById('inlineSuggest');
  const suggestToggle = document.getElementById('suggestionToggle');
  const suggestClose = document.getElementById('suggestionClose');

  if (!draftEl || !tipsEl || !questionEl || !suggestBox || !suggestToggle || !suggestClose) {
    console.error('Reply page: missing elements for suggestions');
    return;
  }

  let lastCallAt = 0;
  const DEBOUNCE_MS = 1200; // user pause
  const PERIODIC_MS = 6000; // background refresh
  const CALL_COOLDOWN = 3500; // minimum gap
  let debounceT;
  const mode = {{ '"rephrase"' if letter.is_flagged else '"reply"' }};
  const letterCtx = {{ letter.content|tojson }};

  function shouldCall(){ return (Date.now() - lastCallAt) > CALL_COOLDOWN; }

  async function loadTips(force=false){
    try{
      if(!force && !shouldCall()) return;
      const content = draftEl.value || '';
      const r = await fetch('/api/coach', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ content, mode, letter: letterCtx })
      });
      lastCallAt = Date.now();
      const data = await r.json();
      const tips = Array.isArray(data.tips) ? data.tips : [];
      tipsEl.innerHTML = tips.map(t => '<li>'+ (t||'').replace(/</g,'&lt;') +'</li>').join('');
      if(data.question && questionEl){ questionEl.textContent = data.question; }
    }catch(e){ console.error('Reply page: Coach API error:', e); }
  }

  suggestToggle.addEventListener('click', async () => {
    suggestToggle.classList.add('hidden');
    suggestBox.classList.remove('hidden');
    await loadTips(true);
  });
  suggestClose.addEventListener('click', () => {
    suggestBox.classList.add('hidden');
    suggestToggle.classList.remove('hidden');
  });

  draftEl.addEventListener('input', () => {
    clearTimeout(debounceT);
    debounceT = setTimeout(() => loadTips(true), DEBOUNCE_MS);
  });
  setInterval(() => loadTips(false), PERIODIC_MS);

  // Prime once
  setTimeout(() => { if(shouldCall()) loadTips(true); }, 400);
});
</script>
{% endblock %}